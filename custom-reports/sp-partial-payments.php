<?php
$branches_targets = [
    98 => ['name' => 'Adams', 'target' => 80000.00],
    65 => ['name' => 'Ahero', 'target' => 80000.00],
    97 => ['name' => 'Bahati', 'target' => 40000.00],
    61 => ['name' => 'Bomet', 'target' => 80000.00],
    36 => ['name' => 'Bondo', 'target' => 80000.00],
    116 => ['name' => 'Bumala', 'target' => 40000.00],
    22 => ['name' => 'Bungoma', 'target' => 80000.00],
    49 => ['name' => 'Burnt Forest', 'target' => 80000.00],
    35 => ['name' => 'Busia', 'target' => 80000.00],
    77 => ['name' => 'Butere', 'target' => 40000.00],
    102 => ['name' => 'Changamwe', 'target' => 80000.00],
    30 => ['name' => 'Chuka', 'target' => 80000.00],
    79 => ['name' => 'Chwele', 'target' => 80000.00],
    41 => ['name' => 'Dagoretti', 'target' => 80000.00],
    48 => ['name' => 'Eldama Ravine', 'target' => 80000.00],
    33 => ['name' => 'Eldoret', 'target' => 80000.00],
    94 => ['name' => 'Emali', 'target' => 80000.00],
    6 => ['name' => 'Embu', 'target' => 80000.00],
    21 => ['name' => 'Engineer', 'target' => 80000.00],
    96 => ['name' => 'Garissa', 'target' => 80000.00],
    10 => ['name' => 'Gatundu', 'target' => 80000.00],
    60 => ['name' => 'Gilgil', 'target' => 80000.00],
    56 => ['name' => 'Githunguri', 'target' => 80000.00],
    67 => ['name' => 'Homabay', 'target' => 80000.00],
    1 => ['name' => 'HQ', 'target' => 80000.00],
    117 => ['name' => 'Isebania', 'target' => 40000.00],
    26 => ['name' => 'Isiolo', 'target' => 80000.00],
    82 => ['name' => 'Iten', 'target' => 80000.00],
    99 => ['name' => 'Jogoo Road', 'target' => 80000.00],
    51 => ['name' => 'Kabarnet', 'target' => 80000.00],
    8 => ['name' => 'Kagio', 'target' => 80000.00],
    118 => ['name' => 'Kahatia', 'target' => 40000.00],
    55 => ['name' => 'Kajiado', 'target' => 80000.00],
    23 => ['name' => 'Kakamega', 'target' => 80000.00],
    17 => ['name' => 'Kamulu', 'target' => 40000.00],
    11 => ['name' => 'Kangari', 'target' => 80000.00],
    84 => ['name' => 'Kapcherop', 'target' => 80000.00],
    39 => ['name' => 'Kapsabet', 'target' => 80000.00],
    122 => ['name' => 'Kapskwony', 'target' => 40000.00],
    83 => ['name' => 'kapsowar', 'target' => 80000.00],
    58 => ['name' => 'Kariobangi North', 'target' => 80000.00],
    101 => ['name' => 'Kasarani', 'target' => 80000.00],
    40 => ['name' => 'Kawangware', 'target' => 80000.00],
    121 => ['name' => 'Kehancha', 'target' => 40000.00],
    59 => ['name' => 'Kenol', 'target' => 80000.00],
    38 => ['name' => 'Kericho', 'target' => 80000.00],
    92 => ['name' => 'Keroka', 'target' => 80000.00],
    14 => ['name' => 'Kerugoya', 'target' => 80000.00],
    3 => ['name' => 'Kiambu', 'target' => 80000.00],
    104 => ['name' => 'Kibwezi', 'target' => 80000.00],
    124 => ['name' => 'Kikima', 'target' => 40000.00],
    89 => ['name' => 'Kilgoris', 'target' => 80000.00],
    71 => ['name' => 'Kilifi', 'target' => 80000.00],
    87 => ['name' => 'Kimana', 'target' => 80000.00],
    57 => ['name' => 'Kimende', 'target' => 80000.00],
    76 => ['name' => 'Kimilili', 'target' => 80000.00],
    126 => ['name' => 'Kinamba', 'target' => 40000.00],
    4 => ['name' => 'Kinoo', 'target' => 80000.00],
    12 => ['name' => 'Kiriani', 'target' => 80000.00],
    86 => ['name' => 'Kisumu', 'target' => 80000.00],
    34 => ['name' => 'Kitale', 'target' => 80000.00],
    52 => ['name' => 'Kitengela', 'target' => 80000.00],
    19 => ['name' => 'Kitui', 'target' => 80000.00],
    120 => ['name' => 'Lessos', 'target' => 40000.00],
    62 => ['name' => 'Letein', 'target' => 80000.00],
    28 => ['name' => 'Limuru', 'target' => 80000.00],
    37 => ['name' => 'Luanda', 'target' => 80000.00],
    9 => ['name' => 'Machakos', 'target' => 40000.00],
    81 => ['name' => 'Makutano-Kapenguria', 'target' => 80000.00],
    111 => ['name' => 'Malaba', 'target' => 80000.00],
    72 => ['name' => 'Malindi', 'target' => 80000.00],
    112 => ['name' => 'Maralal', 'target' => 40000.00],
    91 => ['name' => 'Mariakani', 'target' => 80000.00],
    50 => ['name' => 'Marigat', 'target' => 80000.00],
    108 => ['name' => 'Marimanti', 'target' => 40000.00],
    80 => ['name' => 'Matunda', 'target' => 80000.00],
    18 => ['name' => 'Matuu', 'target' => 80000.00],
    93 => ['name' => 'Maua', 'target' => 80000.00],
    24 => ['name' => 'Mbale', 'target' => 80000.00],
    105 => ['name' => 'Mbita', 'target' => 80000.00],
    68 => ['name' => 'Migori', 'target' => 80000.00],
    115 => ['name' => 'Mikinduri', 'target' => 40000.00],
    46 => ['name' => 'Molo', 'target' => 80000.00],
    73 => ['name' => 'Mtwapa', 'target' => 80000.00],
    114 => ['name' => 'Mukurweini', 'target' => 40000.00],
    32 => ['name' => 'Mumias', 'target' => 80000.00],
    95 => ['name' => 'Muranga', 'target' => 80000.00],
    29 => ['name' => 'Mwea', 'target' => 80000.00],
    106 => ['name' => 'Mwingi', 'target' => 80000.00],
    7 => ['name' => 'Naivasha', 'target' => 80000.00],
    47 => ['name' => 'Nakuru', 'target' => 80000.00],
    25 => ['name' => 'Nanyuki', 'target' => 80000.00],
    64 => ['name' => 'Narok', 'target' => 80000.00],
    43 => ['name' => 'Ngong', 'target' => 80000.00],
    110 => ['name' => 'Njoro', 'target' => 40000.00],
    31 => ['name' => 'Nkubu', 'target' => 80000.00],
    13 => ['name' => 'Nyahururu', 'target' => 80000.00],
    74 => ['name' => 'Nyali', 'target' => 80000.00],
    15 => ['name' => 'Nyeri', 'target' => 80000.00],
    109 => ['name' => 'Olenguruone', 'target' => 40000.00],
    66 => ['name' => 'Oyugis', 'target' => 80000.00],
    54 => ['name' => 'Pipeline', 'target' => 80000.00],
    103 => ['name' => 'Port Victoria', 'target' => 80000.00],
    44 => ['name' => 'Rongai', 'target' => 80000.00],
    70 => ['name' => 'Rongo', 'target' => 80000.00],
    16 => ['name' => 'Ruai', 'target' => 80000.00],
    45 => ['name' => 'Ruiru', 'target' => 80000.00],
    123 => ['name' => 'Runyenjes', 'target' => 40000.00],
    78 => ['name' => 'Serem', 'target' => 80000.00],
    119 => ['name' => 'Siakago', 'target' => 40000.00],
    69 => ['name' => 'Siaya', 'target' => 80000.00],
    90 => ['name' => 'Sondu', 'target' => 80000.00],
    63 => ['name' => 'Sotik', 'target' => 80000.00],
    107 => ['name' => 'Taita Taveta', 'target' => 80000.00],
    5 => ['name' => 'Thika', 'target' => 80000.00],
    85 => ['name' => 'Turbo', 'target' => 80000.00],
    125 => ['name' => 'Ugunja', 'target' => 80000.00],
    75 => ['name' => 'Ukunda', 'target' => 80000.00],
    100 => ['name' => 'umoja', 'target' => 80000.00],
    88 => ['name' => 'Voi', 'target' => 80000.00],
    42 => ['name' => 'Wangige', 'target' => 80000.00],
    27 => ['name' => 'Webuye', 'target' => 80000.00],
    20 => ['name' => 'Wote', 'target' => 80000.00],
    113 => ['name' => 'Wundanyi', 'target' => 40000.00],
];

$loans_ids_arr = [];
$loan_bal_arr = [];
$is_partial = [];
$collections = fetchtable('o_incoming_payments', "status=1 $andbranch_pay AND payment_date >= '$start_date' AND payment_date <= '$start_date'", "uid", "asc", "100000000", "uid, branch_id, amount, loan_id, loan_balance");
$branch_partial_collections_array = array();
$branch_cleared_collections_array = array();
while ($col = mysqli_fetch_array($collections)) {
    $loan_balance = intval($col['loan_balance'] ?? 0);
    $loan_id = $col['loan_id'] ?? 0;
    $current_branch = $col['branch_id'];
    $collections_amount = $col['amount'];
    if ($loan_balance > 0 && $loan_id > 0) {
        $branch_partial_collections_array = obj_add($branch_partial_collections_array, $current_branch, $collections_amount);
    } else if ($loan_balance <= 0 && $loan_id > 0) {
        $branch_cleared_collections_array = obj_add($branch_cleared_collections_array, $current_branch, $collections_amount);
    } else {
        continue;
    }



    if ($current_branch > 0) {
        if (!in_array($loan_id, $loans_ids_arr)) {
            $loans_ids_arr[] = $loan_id;
        }
    }

    if ($loan_id > 0) {
        $loan_bal_arr = obj_add($loan_bal_arr, $loan_id, $loan_balance);
    }
}

$branches_query = "SELECT `uid`, `name` FROM o_branches WHERE uid > 1 AND status=1 $andbranch1 ORDER BY `name` ASC";
$branches_result = mysqli_query($con, $branches_query);
$branches = [];
while ($b = mysqli_fetch_assoc($branches_result)) {
    $uid = $b['uid'];
    $name = $b['name'];
    $branches[$uid] = $name;
}

?>
<div class="col-sm-12">
    <table id="example2" class="table table-condensed table-striped table-bordered">
        <thead>
            <tr>
                <th>Branch</th>
                <th>Full Loan Pays</th>
                <th>Partial Loan Pays</th>
                <th>Total Loan Pays</th>
                <th>Partial Targets</th>
                <th>Variance</th>
                <th>Rate</th>
                <th>Target Status</th>
            </tr>
        </thead>
        <tbody>
            <?php

            $branch_partial_total_sum = $branch_target_sum = $branch_target_variance_sum = $branch_loan_cleared_sum = $branch_all_total_sum  = 0;
            foreach ($branches as $bid => $bname) {
                // difference between $start_date and end_date in days
                $numOfdays = datediff3($end_date, $start_date);
                $branch_partial_total = $branch_partial_collections_array[$bid] ?? 0;
                $branch_loan_cleared = $branch_cleared_collections_array[$bid] ?? 0;
                $branch_all_total = $branch_partial_total + $branch_loan_cleared;
                $branch_target = $branches_targets[$bid]['target'];
                if ($numOfdays > 0) {
                    $numOfdays = $numOfdays + 1;
                    $branch_target = $branch_target * $numOfdays;
                }
                $rate = round(($branch_partial_total / $branch_target) * 100, 2);
                $target_status = ($branch_partial_total >= $branch_target) ? "Met" : "Missed";
                $target_variance = $branch_target - $branch_partial_total;


                // Render a row
                echo "<tr>
                <td>$bname</td>
                <td>" . money($branch_loan_cleared) . "</td>
                <td>" . money($branch_partial_total) . "</td>
                <td>" . money($branch_all_total) . "</td>
                <td>" . money($branch_target) . "</td>
                <td>" . money($branch_target - $branch_partial_total) . "</td>
                <td>$rate%</td>
                <td>$target_status</td>
            </tr>";

                /// Do the summations on every row loop
                $branch_partial_total_sum = $branch_partial_total_sum + $branch_partial_total;
                $branch_loan_cleared_sum = $branch_loan_cleared_sum + $branch_loan_cleared;
                $branch_target_sum = $branch_target_sum + $branch_target;
                $branch_target_variance_sum = $branch_target_variance_sum + ($branch_target - $branch_partial_total);
                $branch_all_total_sum = $branch_all_total_sum + $branch_all_total;
            }

            ?>
        </tbody>
        <tfoot>
            <tr>
                <th>Total</th>
                <th><?php echo money($branch_loan_cleared_sum); ?></th>
                <th><?php echo money($branch_partial_total_sum); ?></th>
                <th><?php echo money($branch_all_total_sum); ?></th>
                <th><?php echo money($branch_target_sum); ?></th>
                <th><?php echo money($branch_target_variance_sum); ?></th>
                <th><?php echo money(round(($branch_partial_total_sum / $branch_target_sum) * 100, 2)); ?>%</th>
                <th></th>
            </tr>
        </tfoot>
    </table>
</div>

<?php
// include close connection
include_once("../configs/close_connection.inc");
